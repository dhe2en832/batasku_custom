[
 {
  "allow_guest": 0,
  "api_method": "calculate_sales_invoice_commission",
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-02-17 17:21:09.682180",
  "module": "Batasku Custom",
  "name": "Calculate Sales Invoice Commission",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "import frappe\r\n\r\nsales_invoice = frappe.form_dict.get(\"sales_invoice\")\r\nif not sales_invoice:\r\n    frappe.throw(\"sales_invoice is required\")\r\n\r\nsi = frappe.get_doc(\"Sales Invoice\", sales_invoice)\r\n\r\n# Default reset\r\ntotal_commission = 0\r\n\r\nif not si.sales_team:\r\n    for item in si.items:\r\n        item.custom_komisi_sales = 0\r\n\r\n    si.custom_total_komisi_sales = 0\r\n    si.save(ignore_permissions=True)\r\n\r\n    frappe.response[\"message\"] = {\r\n        \"sales_invoice\": si.name,\r\n        \"message\": \"No sales team\"\r\n    }\r\n\r\nelse:\r\n    sales_person = si.sales_team[0].sales_person\r\n\r\n    rate = frappe.db.get_value(\r\n        \"Sales Person\",\r\n        sales_person,\r\n        \"custom_default_commission_rate\"\r\n    ) or 0\r\n\r\n    rate = rate / 100\r\n\r\n    for item in si.items:\r\n        margin = item.margin_rate_or_amount or 0\r\n        qty = item.qty or 0\r\n\r\n        commission = margin * qty * rate\r\n        item.custom_komisi_sales = commission\r\n        total_commission += commission\r\n\r\n    si.custom_total_komisi_sales = total_commission\r\n    si.save(ignore_permissions=True)\r\n\r\n    frappe.response[\"message\"] = {\r\n        \"sales_invoice\": si.name,\r\n        \"sales_person\": sales_person,\r\n        \"rate\": rate * 100,\r\n        \"total_commission\": total_commission\r\n    }\r\n",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": "preview_sales_invoice_commission",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-02-18 17:11:26.605013",
  "module": "Batasku Custom",
  "name": "preview_sales_invoice_commission",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "# API: preview_sales_invoice_commission\n# Script Type: API\n# Allowed Roles: System Manager / Accounts User\n\ndelivery_note = frappe.form_dict.get(\"delivery_note\")\n\nif not delivery_note:\n    frappe.throw(\"delivery_note is required\")\n\ndn = frappe.get_doc(\"Delivery Note\", delivery_note)\n\n# Ambil snapshot persentase komisi DN (Percent → desimal)\ncommission_rate = 0.0\n\nrate_snapshot = dn.get(\"custom_persentase_komisi_dn\")\n\nif rate_snapshot:\n    commission_rate = float(rate_snapshot) / 100\nelse:\n    # Fallback: default Sales Person\n    sales_person = None\n\n    if dn.sales_team:\n        sales_person = dn.sales_team[0].sales_person\n    elif dn.customer:\n        cust = frappe.get_doc(\"Customer\", dn.customer)\n        if cust.sales_team:\n            sales_person = cust.sales_team[0].sales_person\n\n    if sales_person:\n        rate = frappe.db.get_value(\n            \"Sales Person\",\n            sales_person,\n            \"custom_default_commission_rate\"\n        ) or 0\n        commission_rate = float(rate) / 100\n\nitems = []\ntotal_commission = 0.0\n\nfor d in dn.items:\n    margin = float(d.margin_rate_or_amount or 0)\n    qty = float(d.qty or 0)\n\n    commission = margin * qty * commission_rate\n\n    items.append({\n        \"item_code\": d.item_code,\n        \"qty\": qty,\n        \"margin\": margin,\n        \"commission\": commission\n    })\n\n    total_commission += commission\n\nfrappe.response[\"preview_available\"] = True\nfrappe.response[\"commission_rate\"] = commission_rate * 100  # tampilkan %\nfrappe.response[\"items\"] = items\nfrappe.response[\"total_commission\"] = total_commission\n",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": "fetch_po_detail_for_pr",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-02-09 23:08:00.014949",
  "module": "Batasku Custom",
  "name": "fetch_po_detail_for_pr",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Purchase Receipt",
  "script": "# Server Script: fetch_po_detail_for_pr\r\n# Type: API\r\n\r\npo_name = frappe.form_dict.get(\"po\")\r\n\r\nif not po_name:\r\n    frappe.throw(\"Parameter po wajib dikirim\")\r\n\r\n# Ambil dokumen PO\r\npo = frappe.get_doc(\"Purchase Order\", po_name)\r\n\r\nitems = []\r\n\r\nfor row in po.items:\r\n    items.append({\r\n        \"item_code\": row.item_code,\r\n        \"item_name\": row.item_name,\r\n        \"description\": row.description,\r\n        \"qty\": row.qty,\r\n        \"uom\": row.uom,\r\n        \"rate\": row.rate,\r\n        \"warehouse\": row.warehouse,\r\n\r\n        # RELASI WAJIB PO → PR\r\n        \"purchase_order\": po.name,\r\n        \"purchase_order_item\": row.name,\r\n\r\n        # DELIVERY DATE\r\n        \"schedule_date\": row.schedule_date\r\n    })\r\n\r\n# RESPONSE FINAL (FORMAT YANG KAMU MINTA)\r\nfrappe.response[\"message\"] = {\r\n    \"success\": True,\r\n    \"data\": {\r\n        \"name\": po.name,\r\n        \"supplier\": po.supplier,\r\n        \"supplier_name\": po.supplier_name,\r\n        \"transaction_date\": po.transaction_date,\r\n        \"warehouse\": po.set_warehouse,\r\n        \"custom_notes_po\": po.custom_notes_po,\r\n        \"items\": items\r\n    }\r\n}\r\n",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": "fetch_pr_detail_for_pi",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-02-15 14:06:29.486036",
  "module": "Batasku Custom",
  "name": "fetch_pr_detail_for_pi",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "# Server Script: fetch_pr_detail_for_pi_final_v5\n# Type: API\n\npr_name = frappe.form_dict.get(\"pr\")\n\nif not pr_name:\n    frappe.throw(\"Parameter pr wajib dikirim\")\n\n# =========================\n# Ambil dokumen PR\n# =========================\n\npr = frappe.get_doc(\"Purchase Receipt\", pr_name)\n\n# =========================\n# Ambil alamat supplier\n# =========================\n\nsupplier_address = None\nsupplier_address_display = None\n\naddress = frappe.db.sql(\"\"\"\n    SELECT addr.name\n    FROM `tabAddress` addr\n    INNER JOIN `tabDynamic Link` dl\n        ON dl.parent = addr.name\n    WHERE dl.link_doctype = 'Supplier'\n        AND dl.link_name = %s\n        AND addr.disabled = 0\n    ORDER BY addr.is_primary_address DESC\n    LIMIT 1\n\"\"\", pr.supplier, as_dict=True)\n\nif address:\n    supplier_address = address[0].name\n    supplier_address_display = frappe.get_doc(\"Address\", supplier_address).get_display()\n\n# =========================\n# Fallback custom_notes_pr\n# =========================\n\ncustom_notes = pr.custom_notes_pr\n\nif not custom_notes:\n    custom_notes = pr.remarks\n\n# =========================\n# Build items untuk PI\n# =========================\n\nitems = []\n\nfor row in pr.items:\n    received_qty = row.received_qty or 0\n    rejected_qty = row.rejected_qty or 0\n    billed_qty = row.billed_qty or 0\n\n    # qty diterima bersih\n    accepted_qty = received_qty - rejected_qty\n\n    po_name = row.purchase_order\n    po_item = row.purchase_order_item\n\n    # =============================\n    # AUTO LOOKUP PO ITEM JIKA NULL\n    # =============================\n    if po_name and not po_item:\n        po_item = frappe.db.get_value(\n            \"Purchase Order Item\",\n            {\"parent\": po_name, \"item_code\": row.item_code},\n            \"name\"\n        )\n\n    # =============================\n    # Hitung qty PI dari PO Item\n    # =============================\n    if po_item:\n        po_item_qty = frappe.db.get_value(\n            \"Purchase Order Item\", po_item, \"qty\"\n        ) or 0\n        qty_pi = po_item_qty - billed_qty\n    else:\n        qty_pi = (row.qty or 0) - billed_qty\n\n    if qty_pi <= 0:\n        continue\n\n    # Build item dict\n    item_dict = {\n        \"item_code\": row.item_code,\n        \"item_name\": row.item_name,\n        \"description\": row.description,\n        \"received_qty\": accepted_qty,\n        \"rejected_qty\": rejected_qty,\n        \"billed_qty\": billed_qty,\n        \"outstanding_qty\": qty_pi,\n        \"qty\": qty_pi,\n        \"uom\": row.uom,\n        \"rate\": row.rate,\n        \"warehouse\": row.warehouse,\n        \"purchase_receipt\": pr.name,\n        \"purchase_receipt_item\": row.name\n    }\n\n    if po_name:\n        item_dict[\"purchase_order\"] = po_name\n\n    if po_item:\n        item_dict[\"purchase_order_item\"] = po_item\n\n    items.append(item_dict)\n\n# =========================\n# Response final\n# =========================\n\nfrappe.response[\"message\"] = {\n    \"success\": True,\n    \"data\": {\n        \"name\": pr.name,\n        \"supplier\": pr.supplier,\n        \"supplier_name\": pr.supplier_name,\n        \"posting_date\": pr.posting_date,\n        \"company\": pr.company,\n        \"custom_notes_pr\": custom_notes,\n        \"supplier_address\": supplier_address,\n        \"supplier_address_display\": supplier_address_display,\n        \"items\": items\n    }\n}\n",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": "fetch_pr_list_for_pi",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-02-11 23:39:17.233238",
  "module": "Batasku Custom",
  "name": "fetch_pr_list_for_pi",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "# Server Script: fetch_pr_list_for_pi\n# Type: API\n\ncompany = frappe.form_dict.get(\"company\")\n\n# =========================\n# Ambil PR yang sudah dipakai di PI (Draft & Submitted saja)\n# =========================\n\nused_pr = frappe.db.sql(\"\"\"\n    SELECT DISTINCT pii.purchase_receipt\n    FROM `tabPurchase Invoice Item` pii\n    INNER JOIN `tabPurchase Invoice` pi\n        ON pii.parent = pi.name\n    WHERE pii.purchase_receipt IS NOT NULL\n    AND pi.docstatus IN (0,1)\n\"\"\", as_dict=True)\n\nused_pr_names = [d.purchase_receipt for d in used_pr if d.purchase_receipt]\n\n# =========================\n# Filter PR\n# =========================\n\nfilters = [\n    [\"docstatus\", \"=\", 1],\n    [\"status\", \"=\", \"To Bill\"]\n]\n\nif company:\n    filters.append([\"company\", \"=\", company])\n\nif used_pr_names:\n    filters.append([\"name\", \"not in\", used_pr_names])\n\n# =========================\n# Ambil Data PR\n# =========================\n\npr_list = frappe.get_all(\n    \"Purchase Receipt\",\n    filters=filters,\n    fields=[\n        \"name\",\n        \"supplier\",\n        \"supplier_name\",\n        \"posting_date\",\n        \"company\",\n        \"grand_total\",\n        \"per_billed\",\n        \"status\"\n    ],\n    order_by=\"posting_date desc\"\n)\n\nfrappe.response[\"message\"] = {\n    \"success\": True,\n    \"data\": pr_list\n}\n",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": "fetch_pi_detail",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-02-13 20:16:27.500476",
  "module": "Batasku Custom",
  "name": "fetch_pi_detail",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "# Server Script: fetch_pi_detail\n# Type: API\n\npi_name = frappe.form_dict.get(\"pi\")\n\nif not pi_name:\n    frappe.throw(\"Parameter pi wajib dikirim\")\n\n# =========================\n# AMBIL DOKUMEN PI\n# =========================\n\npi = frappe.get_doc(\"Purchase Invoice\", pi_name)\n\n# =========================\n# ITEMS\n# =========================\n\nitems = []\n\nfor row in pi.items:\n    items.append({\n        \"name\": row.name,\n        \"item_code\": row.item_code,\n        \"item_name\": row.item_name,\n        \"description\": row.description,\n        \"qty\": row.qty,\n        \"uom\": row.uom,\n        \"rate\": row.rate,\n        \"amount\": row.amount,\n        \"warehouse\": row.warehouse,\n        \"purchase_receipt\": row.purchase_receipt,\n        \"pr_detail\": row.pr_detail\n    })\n\n# =========================\n# TAXES (jika ada)\n# =========================\n\ntaxes = []\n\nfor tax in pi.taxes:\n    taxes.append({\n        \"charge_type\": tax.charge_type,\n        \"account_head\": tax.account_head,\n        \"rate\": tax.rate,\n        \"tax_amount\": tax.tax_amount,\n        \"description\": tax.description\n    })\n\n# =========================\n# RESPONSE FINAL\n# =========================\n\nfrappe.response[\"message\"] = {\n    \"success\": True,\n    \"data\": {\n        \"name\": pi.name,\n        \"supplier\": pi.supplier,\n        \"supplier_name\": pi.supplier_name,\n        \"company\": pi.company,\n        \"posting_date\": pi.posting_date,\n        \"due_date\": pi.due_date,\n        \"bill_no\": pi.bill_no,\n        \"bill_date\": pi.bill_date,\n        \"currency\": pi.currency,\n        \"remarks\": pi.remarks,\n\n        # ✅ CUSTOM FIELD DITAMBAHKAN\n        \"custom_notes_pi\": pi.custom_notes_pi,\n\n        \"supplier_address\": pi.supplier_address,\n        \"address_display\": pi.address_display,\n\n        \"grand_total\": pi.grand_total,\n        \"net_total\": pi.net_total,\n        \"total_taxes_and_charges\": pi.total_taxes_and_charges,\n        \"docstatus\": pi.docstatus,\n\n        \"items\": items,\n        \"taxes\": taxes\n    }\n}\n",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-02-12 23:42:29.543606",
  "module": "Batasku Custom",
  "name": "Auto Set PO PR Details",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Purchase Invoice Item",
  "script": "# Auto set po_detail dari purchase_order\nif doc.purchase_order:\n    doc.po_detail = doc.purchase_order\n\n# Auto set pr_detail dari purchase_receipt  \nif doc.purchase_receipt:\n    doc.pr_detail = doc.purchase_receipt",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-02-14 16:39:54.179747",
  "module": "Batasku Custom",
  "name": "Auto Commission Journal on SI Submit",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Sales Invoice",
  "script": "# ===============================\n# Server Script: Auto Commission JE (Final)\n# Trigger: Sales Invoice on_submit\n# ===============================\n\nif doc.custom_total_komisi_sales and not doc.get(\"custom_commission_journal_entry\"):\n    total_commission = doc.custom_total_komisi_sales\n\n    if total_commission <= 0:\n        frappe.msgprint(f\"Sales Invoice {doc.name} tidak memiliki komisi, JE tidak dibuat.\")\n    else:\n        company = doc.company\n\n        # Cari akun Expense & Payable secara fleksibel\n        expense_keywords = [\"Beban Komisi Penjualan\", \"Komisi Penjualan\"]\n        payable_keywords = [\"Hutang Komisi Sales\", \"Komisi Sales\"]\n\n        expense_account = None\n        payable_account = None\n\n        for kw in expense_keywords:\n            expense_account = frappe.db.get_value(\n                \"Account\",\n                {\"company\": company, \"account_type\": \"Expense Account\", \"account_name\": [\"like\", f\"%{kw}%\"]},\n                \"name\"\n            )\n            if expense_account:\n                break\n\n        for kw in payable_keywords:\n            payable_account = frappe.db.get_value(\n                \"Account\",\n                {\"company\": company, \"account_type\": \"Payable\", \"account_name\": [\"like\", f\"%{kw}%\"]},\n                \"name\"\n            )\n            if payable_account:\n                break\n\n        if not expense_account:\n            frappe.throw(f\"Tidak ditemukan akun Expense untuk komisi di company '{company}'\")\n        if not payable_account:\n            frappe.throw(f\"Tidak ditemukan akun Payable untuk komisi di company '{company}'\")\n\n        # Ambil Sales Order dari item pertama\n        if not doc.items or not doc.items[0].sales_order:\n            frappe.throw(f\"Sales Invoice {doc.name} tidak memiliki Sales Order di item pertama. JE tidak bisa dibuat.\")\n\n        first_so = doc.items[0].sales_order\n\n        # Ambil Sales Team dari SO pertama\n        sales_person_list = frappe.get_all(\n            \"Sales Team\",\n            filters={\"parent\": first_so},\n            fields=[\"sales_person\"]\n        )\n\n        if not sales_person_list:\n            frappe.throw(f\"Sales Order {first_so} tidak memiliki Sales Person. JE tidak bisa dibuat.\")\n\n        # Loop cek Employee untuk tiap Sales Person\n        employee_party = None\n        employee_debug_list = []\n\n        for sp in sales_person_list:\n            emp = frappe.db.get_value(\"Sales Person\", sp.sales_person, \"employee\")\n            employee_debug_list.append({\n                \"so\": first_so,\n                \"sales_person\": sp.sales_person,\n                \"employee\": emp\n            })\n            if emp and not employee_party:\n                employee_party = emp  # ambil Employee pertama yang valid\n\n        # Log debug aman\n        error_message = f\"Sales Invoice {doc.name}: Sales Team & Employee mapping: {employee_debug_list}\"\n        frappe.log_error(\n            message=error_message,  # panjang >140 oke\n            title=f\"Commission JE Debug {doc.name}\"  # title pendek <140\n        )\n\n        # Validasi: JE hanya dibuat jika ada Employee\n        if not employee_party:\n            frappe.throw(\n                f\"Sales Invoice {doc.name}: Tidak ditemukan Employee untuk komisi di Sales Order {first_so}. \"\n                \"Pastikan semua Sales Person terkait Employee sebelum submit.\"\n            )\n\n        # Buat Journal Entry\n        je = frappe.new_doc(\"Journal Entry\")\n        je.voucher_type = \"Journal Entry\"\n        je.posting_date = doc.posting_date\n        je.company = company\n        je.user_remark = f\"Auto Commission for {doc.name}\"\n\n        # Debit Expense\n        je.append(\"accounts\", {\n            \"account\": expense_account,\n            \"debit_in_account_currency\": total_commission\n        })\n\n        # Credit Payable dengan Employee\n        je.append(\"accounts\", {\n            \"account\": payable_account,\n            \"credit_in_account_currency\": total_commission,\n            \"party_type\": \"Employee\",\n            \"party\": employee_party\n        })\n\n        je.insert(ignore_permissions=True)\n        je.submit()\n\n        doc.db_set(\"custom_commission_journal_entry\", je.name)\n        frappe.msgprint(f\"Journal Entry {je.name} berhasil dibuat untuk komisi Sales Invoice {doc.name}\")\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": "get_paid_sales_invoices",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-02-14 12:53:34.545721",
  "module": "Batasku Custom",
  "name": "get_paid_sales_invoices",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "import frappe\n\ncompany = frappe.form_dict.get(\"company\")\nsales_person = frappe.form_dict.get(\"sales_person\")\n\nif not company:\n    frappe.throw(\"Company is required\")\n\nif not sales_person:\n    frappe.throw(\"Sales Person is required\")\n\ninvoices = frappe.db.sql(\"\"\"\n    SELECT\n        si.name,\n        si.posting_date,\n        si.customer,\n        si.grand_total,\n        si.custom_total_komisi_sales\n    FROM `tabSales Invoice` si\n    INNER JOIN `tabSales Team` st\n        ON st.parent = si.name\n    WHERE\n        si.company = %s\n        AND st.sales_person = %s\n        AND si.docstatus = 1\n        AND si.outstanding_amount = 0\n        AND IFNULL(si.custom_commission_paid, 0) = 0\n    ORDER BY si.posting_date DESC\n\"\"\", (company, sales_person), as_dict=True)\n\nfrappe.response[\"message\"] = invoices\n",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": "fetch_so_list_for_dn",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-02-15 19:59:51.155056",
  "module": "Batasku Custom",
  "name": "fetch_so_list_for_dn",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "# Type: API\n# Nama Script: fetch_so_list_for_dn\n# Doctype: N/A\n# fetch_so_list_for_dn\n\ndef fetch_so_list_for_dn(customer=None, company=None, sales_person=None):\n    \"\"\"\n    Fetch Sales Order List untuk Delivery Note.\n    Filter:\n    - Submitted (docstatus = 1)\n    - Belum fully delivered\n    - Belum ada Delivery Note (draft maupun submitted)\n    - Optional filter: customer, company, sales_person\n    \"\"\"\n    filters = {\"docstatus\": 1}\n\n    if customer:\n        filters[\"customer\"] = customer\n    if company:\n        filters[\"company\"] = company\n    if sales_person:\n        filters[\"sales_person\"] = sales_person\n\n    sales_orders = frappe.get_all(\n        \"Sales Order\",\n        filters=filters,\n        fields=[\"name\", \"customer\", \"transaction_date\", \"grand_total\", \"rounded_total\", \"sales_person\"]\n    )\n\n    result = []\n    for so in sales_orders:\n        # Cek SO Item yang belum fully delivered\n        so_items = frappe.get_all(\n            \"Sales Order Item\",\n            filters={\"parent\": so[\"name\"], \"qty\": [\">\", 0], \"delivered_qty\": [\"<\", \"qty\"]},\n            fields=[\"item_code\", \"item_name\", \"qty\", \"delivered_qty\"]\n        )\n        if not so_items:\n            continue  # Semua item sudah delivered, skip\n\n        # Cek apakah SO ini sudah pernah dibuatkan DN (draft maupun submitted)\n        existing_dn = frappe.db.exists(\n            \"Delivery Note Item\",\n            {\"against_sales_order\": so[\"name\"]}\n        )\n        if existing_dn:\n            continue  # Sudah pernah ada DN, skip\n\n        # Masukkan SO yang valid\n        so_copy = so.copy()\n        so_copy[\"items\"] = so_items\n        result.append(so_copy)\n\n    return {\"success\": True, \"data\": result}\n",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": "kas_keluar_multi",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-02-14 17:12:24.472568",
  "module": "Batasku Custom",
  "name": "kas_keluar_multi",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "# Server Script ERPNext - Type: API\n# Name: Multi Expense Cash Out\n# API Method: multi_expense_cash_out\n# Jangan import frappe, sudah tersedia\n\n# payload diambil dari body JSON\npayload = frappe.parse_json(payload)  # kalau payload string\n\nje = frappe.get_doc({\n    \"doctype\": \"Journal Entry\",\n    \"posting_date\": payload[\"posting_date\"],\n    \"voucher_type\": \"Bank Entry\",\n    \"accounts\": []\n})\n\ntotal = 0\nfor item in payload[\"items\"]:\n    je.append(\"accounts\", {\n        \"account\": item[\"kategori\"],  # map kategori ke akun\n        \"debit\": item[\"nominal\"],\n        \"credit\": 0,\n        \"remarks\": item[\"keterangan\"]\n    })\n    total += item[\"nominal\"]\n\n# kredit kas / bank\nje.append(\"accounts\", {\n    \"account\": payload[\"cash_account\"],\n    \"debit\": 0,\n    \"credit\": total,\n    \"remarks\": \"Kas keluar\"\n})\n\nje.insert()\nje.submit()\n\n# kembalikan response ke frontend\nfrappe.local.response[\"message\"] = {\n    \"status\": \"success\",\n    \"journal_entry\": je.name\n}\n",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": "kas_masuk_multi",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-02-14 17:17:22.038441",
  "module": "Batasku Custom",
  "name": "kas_masuk_multi",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "# payload = { posting_date, cash_account, items:[{keterangan, nominal, kategori}] }\npayload = frappe.parse_json(payload)  # parse jika string\n\nje = frappe.get_doc({\n    \"doctype\": \"Journal Entry\",\n    \"posting_date\": payload[\"posting_date\"],\n    \"voucher_type\": \"Bank Entry\",\n    \"accounts\": []\n})\n\n# 1. Kas = Debit\ntotal = 0\nfor item in payload[\"items\"]:\n    je.append(\"accounts\", {\n        \"account\": payload[\"cash_account\"],\n        \"debit\": item[\"nominal\"],\n        \"credit\": 0,\n        \"remarks\": item[\"keterangan\"]\n    })\n    total += item[\"nominal\"]\n\n# 2. Sumber / Kategori = Kredit\nfor item in payload[\"items\"]:\n    je.append(\"accounts\", {\n        \"account\": item[\"kategori\"],  # kategori harus sesuai akun ERPNext\n        \"debit\": 0,\n        \"credit\": item[\"nominal\"],\n        \"remarks\": item[\"keterangan\"]\n    })\n\nje.insert()\nje.submit()\n\n# kembalikan response ke frontend\nfrappe.local.response[\"message\"] = {\n    \"status\": \"success\",\n    \"journal_entry\": je.name\n}\n",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": "fetch_po_list_for_pr",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-02-15 13:08:30.975559",
  "module": "Batasku Custom",
  "name": "fetch_po_list_for_pr",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "# Server Script: fetch_po_list_for_pr\n# Type: API\n\ncompany  = frappe.form_dict.get(\"company\")\nsupplier = frappe.form_dict.get(\"supplier\")\n\n# =========================\n# Ambil PO yang sudah dipakai di PR (Draft & Submitted)\n# =========================\n\nused_po = frappe.db.sql(\"\"\"\n    SELECT DISTINCT pri.purchase_order\n    FROM `tabPurchase Receipt Item` pri\n    INNER JOIN `tabPurchase Receipt` pr\n        ON pri.parent = pr.name\n    WHERE pri.purchase_order IS NOT NULL\n      AND pr.docstatus IN (0,1)\n\"\"\", as_dict=True)\n\nused_po_names = [d.purchase_order for d in used_po if d.purchase_order]\n\n# =========================\n# Filter PO\n# =========================\n\nfilters = [\n    [\"docstatus\", \"=\", 1],\n    [\"status\", \"in\", [\"To Receive\", \"To Receive and Bill\"]],\n    [\"per_received\", \"<\", 100]\n]\n\nif company:\n    filters.append([\"company\", \"=\", company])\n\nif supplier:\n    filters.append([\"supplier\", \"=\", supplier])\n\nif used_po_names:\n    filters.append([\"name\", \"not in\", used_po_names])\n\n# =========================\n# Ambil Data PO\n# =========================\n\npo_list = frappe.get_all(\n    \"Purchase Order\",\n    filters=filters,\n    fields=[\n        \"name\",\n        \"supplier\",\n        \"supplier_name\",\n        \"transaction_date\",\n        \"company\",\n        \"grand_total\",\n        \"per_received\",\n        \"per_billed\",\n        \"status\"\n    ],\n    order_by=\"transaction_date desc\"\n)\n\nfrappe.response[\"message\"] = {\n    \"success\": True,\n    \"data\": po_list\n}\n",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": "clear_warkat_payment",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-02-15 19:26:24.071845",
  "module": "Batasku Custom",
  "name": "clear_warkat_payment",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "# Server Script: clear_warkat_payment\n# Type: API\n\n# =========================\n# Ambil parameter\n# =========================\npayment_entry = frappe.form_dict.get(\"payment_entry\")\nbank_account = frappe.form_dict.get(\"bank_account\")\ncompany = frappe.form_dict.get(\"company\")\nclearance_date = frappe.form_dict.get(\"clearance_date\")  # opsional\n\nif not payment_entry:\n    frappe.throw(\"Parameter payment_entry wajib dikirim\")\nif not bank_account:\n    frappe.throw(\"Parameter bank_account wajib dikirim\")\nif not company:\n    frappe.throw(\"Parameter company wajib dikirim\")\n\n# =========================\n# Ambil Payment Entry\n# =========================\npe = frappe.get_doc(\"Payment Entry\", payment_entry)\n\nif pe.company != company:\n    frappe.throw(\"Company mismatch\")\nif pe.docstatus != 1:\n    frappe.throw(\"Payment Entry harus Submitted\")\n\n# =========================\n# Validasi Mode of Payment = Warkat\n# =========================\nmode_type = frappe.db.get_value(\"Mode of Payment\", pe.mode_of_payment, \"type\")\nif mode_type != \"Bank\":\n    frappe.throw(\"Payment Entry bukan transaksi Warkat\")\n\n# =========================\n# Validasi Double Clearing\n# =========================\nif frappe.db.exists(\"Journal Entry\", {\n    \"reference_name\": pe.name,\n    \"docstatus\": 1,\n    \"user_remark\": [\"like\", \"%CLEAR%\"]\n}):\n    frappe.throw(\"Warkat sudah pernah dicairkan\")\n\n# =========================\n# Validasi Akun Paid From dan Bank\n# =========================\npaid_from_acc = frappe.db.get_value(\"Account\", pe.paid_from, [\"account_type\", \"root_type\"], as_dict=True)\nbank_acc = frappe.db.get_value(\"Account\", bank_account, [\"account_type\", \"root_type\", \"disabled\"], as_dict=True)\n\nif not paid_from_acc:\n    frappe.throw(f\"Akun Paid From tidak ditemukan: {pe.paid_from}\")\nif not bank_acc:\n    frappe.throw(f\"Akun Bank tidak ditemukan: {bank_account}\")\nif bank_acc.disabled:\n    frappe.throw(f\"Akun Bank {bank_account} dinonaktifkan, tidak bisa digunakan\")\nif bank_acc.root_type != \"Asset\":\n    frappe.throw(f\"Akun Bank {bank_account} harus Asset\")\n\n# =========================\n# Validasi Paid From sesuai Payment Type\n# =========================\nif pe.payment_type == \"Pay\":\n    # Warkat Keluar → Asset / Current Asset\n    if paid_from_acc.root_type != \"Asset\" or paid_from_acc.account_type != \"Current Asset\":\n        frappe.throw(f\"Paid From harus akun Asset / Current Asset. Saat ini: {pe.paid_from}\")\nelif pe.payment_type == \"Receive\":\n    # Warkat Masuk / Piutang → Asset\n    if paid_from_acc.root_type != \"Asset\":\n        frappe.throw(f\"Paid From harus akun Asset (Piutang / Warkat Masuk). Saat ini: {pe.paid_from}\")\n\n# =========================\n# Buat Journal Entry (Warkat → Bank)\n# =========================\nje = frappe.new_doc(\"Journal Entry\")\nje.voucher_type = \"Bank Entry\"\nje.company = company\nje.posting_date = frappe.utils.today()\nje.user_remark = f\"CLEAR WARKAT dari Payment Entry {pe.name}\"\nje.reference_name = pe.name\nje.reference_date = pe.get(\"posting_date\") or frappe.utils.today()\n\n# Tambahkan nomor & tanggal warkat jika ada\nif pe.get(\"reference_no\"):\n    je.cheque_no = pe.reference_no\nif pe.get(\"reference_date\"):\n    je.cheque_date = pe.reference_date\n\n# =========================\n# Tambahkan akun sesuai Payment Type\n# =========================\nif pe.payment_type == \"Pay\":\n    # Bayar → Debit Bank, Kredit Warkat Keluar (Asset)\n    je.append(\"accounts\", {\n        \"account\": bank_account,\n        \"debit_in_account_currency\": pe.paid_amount\n    })\n    je.append(\"accounts\", {\n        \"account\": pe.paid_from,\n        \"credit_in_account_currency\": pe.paid_amount\n    })\nelif pe.payment_type == \"Receive\":\n    # Terima → Debit Bank, Kredit Warkat Masuk (Asset / Piutang)\n    je.append(\"accounts\", {\n        \"account\": bank_account,\n        \"debit_in_account_currency\": pe.paid_amount\n    })\n    je.append(\"accounts\", {\n        \"account\": pe.paid_from,\n        \"credit_in_account_currency\": pe.paid_amount,\n        \"party_type\": pe.party_type,\n        \"party\": pe.party\n    })\n\n# Insert & submit\nje.insert(ignore_permissions=True)\nje.submit()\n\n# =========================\n# Update Clearance Date Payment Entry (opsional)\n# =========================\nif clearance_date:\n    frappe.db.set_value(\"Payment Entry\", pe.name, \"clearance_date\", clearance_date)\n    frappe.db.commit()\n\n# =========================\n# Response\n# =========================\nfrappe.response[\"message\"] = {\n    \"success\": True,\n    \"journal_entry\": je.name,\n    \"payment_entry\": pe.name,\n    \"status\": \"Cleared\",\n    \"clearance_date\": clearance_date\n}\n",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": "bounce_warkat_payment",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-02-15 18:25:17.501521",
  "module": "Batasku Custom",
  "name": "bounce_warkat_payment",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "# Server Script: bounce_warkat_payment\n# Type: API\n\n# Ambil parameter\npayment_entry = frappe.form_dict.get(\"payment_entry\")\ncompany = frappe.form_dict.get(\"company\")\nreason = frappe.form_dict.get(\"reason\") or \"-\"\n\nif not payment_entry:\n    frappe.throw(\"Parameter payment_entry wajib dikirim\")\nif not company:\n    frappe.throw(\"Parameter company wajib dikirim\")\n\n# Ambil Payment Entry\npe = frappe.get_doc(\"Payment Entry\", payment_entry)\n\nif pe.company != company:\n    frappe.throw(\"Company mismatch\")\nif pe.docstatus != 1:\n    frappe.throw(\"Payment Entry harus Submitted\")\n\n# Validasi Mode of Payment = Warkat (Bank)\nmode_type = frappe.db.get_value(\"Mode of Payment\", pe.mode_of_payment, \"type\")\nif mode_type != \"Bank\":\n    frappe.throw(\"Payment Entry bukan transaksi Warkat\")\n\n# Validasi Double Processing\nif frappe.db.exists(\"Journal Entry\", {\n    \"reference_name\": pe.name,\n    \"docstatus\": 1,\n    \"user_remark\": [\"like\", \"%BOUNCE WARKAT%\"]\n}):\n    frappe.throw(\"Warkat sudah pernah ditolak\")\n\n# Validasi Paid From & Paid To\npaid_from_acc = frappe.db.get_value(\"Account\", pe.paid_from, [\"account_type\", \"root_type\"], as_dict=True)\npaid_to_acc = frappe.db.get_value(\"Account\", pe.paid_to, [\"account_type\", \"root_type\"], as_dict=True)\n\nif not paid_from_acc:\n    frappe.throw(f\"Akun Paid From tidak ditemukan: {pe.paid_from}\")\nif not paid_to_acc:\n    frappe.throw(f\"Akun Paid To tidak ditemukan: {pe.paid_to}\")\n\n# Paid From\nif pe.payment_type == \"Pay\":\n    if paid_from_acc.root_type != \"Asset\" or paid_from_acc.account_type != \"Current Asset\":\n        frappe.throw(f\"Paid From bukan akun Warkat Keluar (Asset - Current Asset). Saat ini: {pe.paid_from}\")\nelif pe.payment_type == \"Receive\":\n    if paid_from_acc.root_type != \"Asset\":\n        frappe.throw(f\"Paid From harus akun Asset (Piutang / Warkat Masuk). Saat ini: {pe.paid_from}\")\n\n# Paid To\nif pe.payment_type == \"Pay\":\n    if paid_to_acc.root_type != \"Liability\":\n        frappe.throw(f\"Paid To harus akun Liability (Hutang Dagang). Saat ini: {pe.paid_to}\")\nelif pe.payment_type == \"Receive\":\n    if paid_to_acc.root_type != \"Asset\":\n        frappe.throw(f\"Paid To harus akun Asset (Bank / Warkat Masuk). Saat ini: {pe.paid_to}\")\n\n# Buat Journal Entry Bounce Warkat\nje = frappe.new_doc(\"Journal Entry\")\nje.voucher_type = \"Journal Entry\"\nje.company = company\nje.posting_date = frappe.utils.today()\nje.user_remark = f\"BOUNCE WARKAT dari Payment Entry {pe.name}. Alasan: {reason}\"\nje.reference_name = pe.name\n\nif pe.payment_type == \"Pay\":\n    je.append(\"accounts\", {\"account\": pe.paid_from, \"debit_in_account_currency\": pe.paid_amount})\n    je.append(\"accounts\", {\"account\": pe.paid_to, \"credit_in_account_currency\": pe.paid_amount, \"party_type\": \"Supplier\", \"party\": pe.party})\nelif pe.payment_type == \"Receive\":\n    je.append(\"accounts\", {\"account\": pe.paid_to, \"debit_in_account_currency\": pe.paid_amount})\n    je.append(\"accounts\", {\"account\": pe.paid_from, \"credit_in_account_currency\": pe.paid_amount, \"party_type\": pe.party_type, \"party\": pe.party})\n\n# Insert & submit Journal Entry\nje.insert(ignore_permissions=True)\nje.submit()\n\n# Cancel Payment Entry\npe.cancel()\n# Update status field jika ada\nif \"status\" in pe.as_dict():\n    pe.db_set(\"status\", \"Cancelled\")\n\n# Response\nfrappe.response[\"message\"] = {\n    \"success\": True,\n    \"journal_entry\": je.name,\n    \"payment_entry\": pe.name,\n    \"payment_entry_status\": pe.docstatus,\n    \"status\": \"Bounced\"\n}\n",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": "pay_sales_commission",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-02-15 21:18:43.540304",
  "module": "Batasku Custom",
  "name": "pay_sales_commission",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "# Server Script: pay_sales_commissions\n# Type: API\n\nimport frappe\n\n# =========================\n# Ambil parameter\n# =========================\n# invoices: list of dict { \"sales_invoice\": \"ACC-SINV-2026-0001\", \"commission_amount\": 500000 }\ninvoices = frappe.form_dict.get(\"invoices\")\npayment_account = frappe.form_dict.get(\"payment_account\")\ncompany = frappe.form_dict.get(\"company\")\nposting_date = frappe.form_dict.get(\"posting_date\") or frappe.utils.today()\n\n# Validasi wajib\nfor param_name, param_value in [\n    (\"invoices\", invoices),\n    (\"payment_account\", payment_account),\n    (\"company\", company),\n]:\n    if not param_value:\n        frappe.throw(f\"Parameter {param_name} wajib dikirim\")\n\nif not isinstance(invoices, list) or len(invoices) == 0:\n    frappe.throw(\"Parameter invoices harus list tidak kosong\")\n\n# =========================\n# Validasi akun pembayaran\n# =========================\npayment_acc = frappe.db.get_value(\"Account\", payment_account, [\"account_type\", \"root_type\", \"disabled\"], as_dict=True)\nif not payment_acc:\n    frappe.throw(f\"Akun Pembayaran tidak ditemukan: {payment_account}\")\nif payment_acc.disabled:\n    frappe.throw(f\"Akun Pembayaran {payment_account} dinonaktifkan\")\nif payment_acc.root_type != \"Asset\":\n    frappe.throw(f\"Akun Pembayaran harus Asset (Kas/Bank). Saat ini: {payment_account}\")\n\n# =========================\n# Buat Journal Entry\n# =========================\nje = frappe.new_doc(\"Journal Entry\")\nje.voucher_type = \"Bank Entry\"\nje.company = company\nje.posting_date = posting_date\nje.user_remark = \"PEMBAYARAN KOMISI SALES MULTI-INVOICE\"\n\ntotal_credit = 0.0\n\nfor inv in invoices:\n    si_name = inv.get(\"sales_invoice\")\n    commission_amount = inv.get(\"commission_amount\", 0.0)\n    if not si_name or commission_amount <= 0:\n        frappe.throw(\"Setiap invoice harus memiliki sales_invoice dan commission_amount > 0\")\n\n    si = frappe.get_doc(\"Sales Invoice\", si_name)\n    if si.company != company:\n        frappe.throw(f\"Company mismatch untuk {si_name}\")\n    if si.docstatus != 1:\n        frappe.throw(f\"Sales Invoice {si_name} harus Submitted\")\n    if si.outstanding_amount > 0:\n        frappe.throw(f\"Sales Invoice {si_name} belum lunas, komisi tidak bisa dibayarkan\")\n    if frappe.db.exists(\"Journal Entry\", {\n        \"reference_name\": si_name,\n        \"docstatus\": 1,\n        \"user_remark\": [\"like\", \"%KOMISI%\"]\n    }):\n        frappe.throw(f\"Komisi sales untuk invoice {si_name} sudah dibayarkan sebelumnya\")\n\n    # Debit akun komisi\n    commission_account = frappe.db.get_value(\"Account\", {\"company\": company, \"account_type\": \"Expense\", \"root_type\": \"Expense\"}, \"name\")\n    if not commission_account:\n        frappe.throw(\"Tidak ada akun Komisi Expense untuk company ini\")\n    je.append(\"accounts\", {\n        \"account\": commission_account,\n        \"debit_in_account_currency\": commission_amount,\n        \"reference_name\": si_name\n    })\n\n    total_credit += commission_amount\n\n# Kredit total ke kas/bank\nje.append(\"accounts\", {\n    \"account\": payment_account,\n    \"credit_in_account_currency\": total_credit\n})\n\n# Insert & submit\nje.insert(ignore_permissions=True)\nje.submit()\n\n# =========================\n# Response\n# =========================\nfrappe.response[\"message\"] = {\n    \"success\": True,\n    \"journal_entry\": je.name,\n    \"total_commission\": total_credit,\n    \"invoice_count\": len(invoices)\n}\n",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": "get_profit_commission_report_dual",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-02-27 21:40:48.082335",
  "module": "Batasku Custom",
  "name": "get_profit_commission_report_dual",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "# ===============================\n# Sales Commission Report (Support Credit Note)\n# Frappe Server Script - NO import statements (safe_exec compatible)\n# ===============================\n\n# --- Ambil parameter dari request ---\nfrom_date    = frappe.form_dict.get(\"from_date\")\nto_date      = frappe.form_dict.get(\"to_date\")\ncompany      = frappe.form_dict.get(\"company\")\nsales_person = frappe.form_dict.get(\"sales_person\")\ncustomer     = frappe.form_dict.get(\"customer\")\nmode         = frappe.form_dict.get(\"mode\") or \"valuation\"\ninclude_hpp  = frappe.form_dict.get(\"include_hpp\") in [1, \"1\", True, \"true\"]\n\n# --- Clamp tanggal agar valid ---\ndef clamp_to_date(date_str):\n    if not date_str:\n        return date_str\n    parts = date_str.split(\"-\")\n    if len(parts) != 3:\n        return date_str\n    year_str  = parts[0]\n    month_str = parts[1]\n    day       = frappe.utils.cint(parts[2])\n    last_day  = 31\n    if month_str in [\"04\", \"06\", \"09\", \"11\"]:\n        last_day = 30\n    elif month_str == \"02\":\n        y = frappe.utils.cint(year_str)\n        last_day = 29 if (y % 4 == 0 and (y % 100 != 0 or y % 400 == 0)) else 28\n    if day > last_day:\n        day = last_day\n    day_str = str(day) if day >= 10 else \"0\" + str(day)\n    return year_str + \"-\" + month_str + \"-\" + day_str\n\nto_date_clamped = clamp_to_date(to_date)\n\n# --- Filter Sales Invoice (TERMASUK CREDIT NOTE) ---\nfilters = {\"docstatus\": 1, \"posting_date\": [\"between\", [from_date, to_date_clamped]]}\nif company:\n    filters[\"company\"] = company\nif customer:\n    filters[\"customer\"] = customer\n\ninvoices = frappe.get_all(\"Sales Invoice\", filters=filters,\n    fields=[\"name\", \"customer\", \"customer_name\", \"company\", \"is_return\", \"return_against\"])\n\ninvoice_map        = {}\ncustomer_name_map  = {}\ninvoice_names      = []\nis_return_map      = {}\nreturn_against_map = {}\n\ni = 0\nwhile i < len(invoices):\n    d = invoices[i]\n    invoice_map[d[\"name\"]]        = d[\"customer\"]\n    customer_name_map[d[\"customer\"]] = d[\"customer_name\"]\n    invoice_names.append(d[\"name\"])\n    is_return_map[d[\"name\"]]      = d.get(\"is_return\", 0)\n    return_against_map[d[\"name\"]] = d.get(\"return_against\")\n    i += 1\n\n# --- Sales Team ---\nsales_team_rows = frappe.get_all(\"Sales Team\",\n    filters={\"parent\": [\"in\", invoice_names]},\n    fields=[\"parent\", \"sales_person\"])\n\ninvoice_sales = {}\ni = 0\nwhile i < len(sales_team_rows):\n    d = sales_team_rows[i]\n    if sales_person and d[\"sales_person\"] != sales_person:\n        i += 1\n        continue\n    invoice_sales[d[\"parent\"]] = d[\"sales_person\"]\n    i += 1\n\n# --- Ambil snapshot persentase komisi header (Percent → desimal) ---\ninvoice_commission_rate = {}\ni = 0\nwhile i < len(invoice_names):\n    inv      = invoice_names[i]\n    rate_pct = frappe.db.get_value(\"Sales Invoice\", inv, \"custom_persentase_komisi_si\") or 40\n    invoice_commission_rate[inv] = frappe.utils.flt(rate_pct) / 100\n    i += 1\n\n# --- Sales Invoice Items ---\nitem_filters = {\"parent\": [\"in\", invoice_names]}\nif sales_person:\n    item_filters[\"parent\"] = [\"in\", list(invoice_sales.keys())]\n\nitems = frappe.get_all(\"Sales Invoice Item\", filters=item_filters,\n    fields=[\"parent\", \"item_code\", \"item_name\", \"qty\", \"rate\", \"price_list_rate\",\n            \"incoming_rate\", \"margin_rate_or_amount\", \"custom_hpp_snapshot\",\n            \"custom_financial_cost_percent\", \"dn_detail\", \"warehouse\"])\n\n# --- Result structure ---\nresult = {\n    \"params\": {\n        \"from_date\":    from_date,\n        \"to_date\":      to_date_clamped,\n        \"company\":      company,\n        \"mode\":         mode,\n        \"include_hpp\":  include_hpp,\n        \"sales_person\": sales_person or \"All\",\n        \"customer\":     customer or \"All\"\n    },\n    \"by_item\":     [],\n    \"by_invoice\":  {},\n    \"by_customer\": {},\n    \"by_sales\":    {},\n    \"summary\": {\n        \"total_sales\":                        0.0,\n        \"total_hpp_base\":                     0.0,\n        \"total_financial_cost\":               0.0,\n        \"total_hpp_total\":                    0.0,\n        \"total_gross_profit_before_overhead\": 0.0,\n        \"total_gross_profit\":                 0.0,\n        \"total_base_profit\":                  0.0,\n        \"total_commission\":                   0.0,\n        \"total_company_margin\":               0.0,\n        \"total_company_profit\":               0.0,\n        \"total_invoices\":                     0,\n        \"total_credit_notes\":                 0,\n        \"total_commission_positive\":          0.0,\n        \"total_commission_negative\":          0.0\n    }\n}\n\n# --- Loop items ---\ni = 0\nwhile i < len(items):\n    row = items[i]\n    inv = row[\"parent\"]\n\n    # Cek apakah ini Credit Note\n    is_return      = is_return_map.get(inv, 0)\n    return_against = return_against_map.get(inv)\n\n    qty          = frappe.utils.flt(row[\"qty\"] or 0)\n    selling      = frappe.utils.flt(row[\"rate\"] or 0)\n    bottom       = frappe.utils.flt(row.get(\"price_list_rate\") or 0)\n    margin_input = frappe.utils.flt(row.get(\"margin_rate_or_amount\") or 0)\n\n    # UNTUK CREDIT NOTE: Qty sudah negatif dari ERPNext\n    qty_abs    = abs(qty)\n    multiplier = -1 if is_return else 1\n\n    # ========================================\n    # AMBIL HPP SESUAI PRIORITAS\n    # ========================================\n    hpp = 0\n\n    if row.get(\"custom_hpp_snapshot\") and frappe.utils.flt(row[\"custom_hpp_snapshot\"]) > 0:\n        hpp = frappe.utils.flt(row[\"custom_hpp_snapshot\"])\n    elif row.get(\"dn_detail\"):\n        dn_hpp = frappe.db.get_value(\"Delivery Note Item\", row[\"dn_detail\"], \"custom_hpp_snapshot\")\n        if dn_hpp and frappe.utils.flt(dn_hpp) > 0:\n            hpp = frappe.utils.flt(dn_hpp)\n        else:\n            dn_incoming = frappe.db.get_value(\"Delivery Note Item\", row[\"dn_detail\"], \"incoming_rate\")\n            if dn_incoming and frappe.utils.flt(dn_incoming) > 0:\n                hpp = frappe.utils.flt(dn_incoming)\n\n    if not hpp and row.get(\"incoming_rate\") and frappe.utils.flt(row[\"incoming_rate\"]) > 0:\n        hpp = frappe.utils.flt(row[\"incoming_rate\"])\n\n    if not hpp:\n        bin_valuation = frappe.db.get_value(\n            \"Bin\",\n            {\"item_code\": row[\"item_code\"], \"warehouse\": row.get(\"warehouse\")},\n            \"valuation_rate\"\n        )\n        if bin_valuation:\n            hpp = frappe.utils.flt(bin_valuation)\n\n    if not hpp:\n        price_list_rate = frappe.db.get_value(\n            \"Item Price\",\n            {\"item_code\": row[\"item_code\"], \"price_list\": \"Standar Pembelian\"},\n            \"price_list_rate\"\n        )\n        if price_list_rate:\n            hpp = frappe.utils.flt(price_list_rate)\n\n    # ========================================\n    # AMBIL FINANCIAL COST %\n    # ========================================\n    financial_cost_percent = 0\n    if row.get(\"custom_financial_cost_percent\"):\n        financial_cost_percent = frappe.utils.flt(row[\"custom_financial_cost_percent\"])\n\n    # ========================================\n    # PERHITUNGAN (dengan multiplier untuk CN)\n    # ========================================\n    sales_amount      = selling * qty_abs * multiplier\n    hpp_base_amount   = hpp * qty_abs * multiplier\n    financial_cost_amount = abs(hpp_base_amount) * (financial_cost_percent / 100) * multiplier\n    hpp_total_amount  = hpp_base_amount + financial_cost_amount\n\n    if mode == \"valuation\":\n        margin_zone = selling - bottom\n        if margin_zone < 0:\n            margin_zone = 0\n\n        gross_profit_before_overhead = (selling - hpp) * qty_abs * multiplier\n        gross_profit                 = gross_profit_before_overhead - financial_cost_amount\n        base_company_profit          = (bottom - hpp) * qty_abs * multiplier - financial_cost_amount\n        company_margin               = margin_zone * qty_abs * 0.60 * multiplier\n\n    else:  # margin\n        margin_zone = abs(margin_input)\n        if margin_zone < 0:\n            margin_zone = 0\n        if include_hpp:\n            gross_profit_before_overhead = (selling - hpp) * qty_abs * multiplier\n            gross_profit                 = gross_profit_before_overhead - financial_cost_amount\n            base_company_profit          = (selling - hpp) * qty_abs * 0.60 * multiplier - financial_cost_amount\n        else:\n            gross_profit_before_overhead = 0.0\n            gross_profit                 = 0.0\n            base_company_profit          = 0.0\n        company_margin = margin_zone * qty_abs * 0.60 * multiplier\n\n    # --- Komisi dengan multiplier untuk CN ---\n    rate             = invoice_commission_rate.get(inv, 0.40)\n    sales_commission = margin_zone * qty_abs * rate * multiplier\n    company_profit   = base_company_profit + company_margin\n\n    cust_id       = invoice_map.get(inv)\n    customer_name = customer_name_map.get(cust_id, cust_id)\n    sp_name       = invoice_sales.get(inv)\n\n    if customer_name != cust_id:\n        cust_key = cust_id + \" - \" + customer_name\n    else:\n        cust_key = cust_id\n\n    sp_key = sp_name or \"Unassigned\"\n\n    # ----------------------------------------\n    # By Item\n    # ----------------------------------------\n    result[\"by_item\"].append({\n        \"invoice\":                      inv,\n        \"is_return\":                    is_return,\n        \"return_against\":               return_against,\n        \"document_type\":                \"Credit Note\" if is_return else \"Invoice\",\n        \"customer\":                     cust_id,\n        \"customer_name\":                customer_name,\n        \"sales_person\":                 sp_name,\n        \"item_code\":                    row[\"item_code\"],\n        \"item_name\":                    row[\"item_name\"],\n        \"qty\":                          qty,\n        \"rate\":                         selling,\n        \"price_list_rate\":              bottom,\n        \"hpp_rate\":                     hpp if (mode == \"valuation\" or include_hpp) else None,\n        \"financial_cost_percent\":       financial_cost_percent if (mode == \"valuation\" or include_hpp) else None,\n        \"sales\":                        sales_amount,\n        \"hpp_base\":                     hpp_base_amount if (mode == \"valuation\" or include_hpp) else None,\n        \"financial_cost\":               financial_cost_amount if (mode == \"valuation\" or include_hpp) else None,\n        \"hpp_total\":                    hpp_total_amount if (mode == \"valuation\" or include_hpp) else None,\n        \"gross_profit_before_overhead\": gross_profit_before_overhead,\n        \"gross_profit\":                 gross_profit,\n        \"base_profit\":                  base_company_profit,\n        \"margin_zone\":                  margin_zone,\n        \"commission\":                   sales_commission,\n        \"company_margin\":               company_margin,\n        \"company_profit\":               company_profit\n    })\n\n    # ----------------------------------------\n    # By Invoice\n    # ----------------------------------------\n    if inv not in result[\"by_invoice\"]:\n        result[\"by_invoice\"][inv] = {\n            \"customer\":                     cust_id,\n            \"sales_person\":                 sp_name,\n            \"is_return\":                    is_return,\n            \"return_against\":               return_against,\n            \"sales\":                        0.0,\n            \"hpp_base\":                     0.0,\n            \"financial_cost\":               0.0,\n            \"hpp_total\":                    0.0,\n            \"gross_profit_before_overhead\": 0.0,\n            \"gross_profit\":                 0.0,\n            \"base_profit\":                  0.0,\n            \"commission\":                   0.0,\n            \"company_margin\":               0.0,\n            \"profit\":                       0.0\n        }\n    inv_row = result[\"by_invoice\"][inv]\n    inv_row[\"sales\"]                        = inv_row[\"sales\"] + sales_amount\n    inv_row[\"hpp_base\"]                     = inv_row[\"hpp_base\"] + (hpp_base_amount if (mode == \"valuation\" or include_hpp) else 0)\n    inv_row[\"financial_cost\"]               = inv_row[\"financial_cost\"] + (financial_cost_amount if (mode == \"valuation\" or include_hpp) else 0)\n    inv_row[\"hpp_total\"]                    = inv_row[\"hpp_total\"] + (hpp_total_amount if (mode == \"valuation\" or include_hpp) else 0)\n    inv_row[\"gross_profit_before_overhead\"] = inv_row[\"gross_profit_before_overhead\"] + gross_profit_before_overhead\n    inv_row[\"gross_profit\"]                 = inv_row[\"gross_profit\"] + gross_profit\n    inv_row[\"base_profit\"]                  = inv_row[\"base_profit\"] + base_company_profit\n    inv_row[\"commission\"]                   = inv_row[\"commission\"] + sales_commission\n    inv_row[\"company_margin\"]               = inv_row[\"company_margin\"] + company_margin\n    inv_row[\"profit\"]                       = inv_row[\"profit\"] + company_profit\n\n    # ----------------------------------------\n    # By Customer\n    # ----------------------------------------\n    if cust_key not in result[\"by_customer\"]:\n        result[\"by_customer\"][cust_key] = {\n            \"invoices\":                     [],\n            \"sales\":                        0.0,\n            \"hpp_base\":                     0.0,\n            \"financial_cost\":               0.0,\n            \"hpp_total\":                    0.0,\n            \"gross_profit_before_overhead\": 0.0,\n            \"gross_profit\":                 0.0,\n            \"base_profit\":                  0.0,\n            \"commission\":                   0.0,\n            \"company_margin\":               0.0,\n            \"profit\":                       0.0\n        }\n    cust = result[\"by_customer\"][cust_key]\n    if inv not in cust[\"invoices\"]:\n        cust[\"invoices\"].append(inv)\n    cust[\"sales\"]                        = cust[\"sales\"] + sales_amount\n    cust[\"hpp_base\"]                     = cust[\"hpp_base\"] + (hpp_base_amount if (mode == \"valuation\" or include_hpp) else 0)\n    cust[\"financial_cost\"]               = cust[\"financial_cost\"] + (financial_cost_amount if (mode == \"valuation\" or include_hpp) else 0)\n    cust[\"hpp_total\"]                    = cust[\"hpp_total\"] + (hpp_total_amount if (mode == \"valuation\" or include_hpp) else 0)\n    cust[\"gross_profit_before_overhead\"] = cust[\"gross_profit_before_overhead\"] + gross_profit_before_overhead\n    cust[\"gross_profit\"]                 = cust[\"gross_profit\"] + gross_profit\n    cust[\"base_profit\"]                  = cust[\"base_profit\"] + base_company_profit\n    cust[\"commission\"]                   = cust[\"commission\"] + sales_commission\n    cust[\"company_margin\"]               = cust[\"company_margin\"] + company_margin\n    cust[\"profit\"]                       = cust[\"profit\"] + company_profit\n\n    # ----------------------------------------\n    # By Sales\n    # ----------------------------------------\n    if sp_key not in result[\"by_sales\"]:\n        result[\"by_sales\"][sp_key] = {\n            \"invoices\":                     [],\n            \"sales\":                        0.0,\n            \"hpp_base\":                     0.0,\n            \"financial_cost\":               0.0,\n            \"hpp_total\":                    0.0,\n            \"gross_profit_before_overhead\": 0.0,\n            \"gross_profit\":                 0.0,\n            \"base_profit\":                  0.0,\n            \"commission\":                   0.0,\n            \"company_margin\":               0.0,\n            \"profit\":                       0.0\n        }\n    sp = result[\"by_sales\"][sp_key]\n    if inv not in sp[\"invoices\"]:\n        sp[\"invoices\"].append(inv)\n    sp[\"sales\"]                        = sp[\"sales\"] + sales_amount\n    sp[\"hpp_base\"]                     = sp[\"hpp_base\"] + (hpp_base_amount if (mode == \"valuation\" or include_hpp) else 0)\n    sp[\"financial_cost\"]               = sp[\"financial_cost\"] + (financial_cost_amount if (mode == \"valuation\" or include_hpp) else 0)\n    sp[\"hpp_total\"]                    = sp[\"hpp_total\"] + (hpp_total_amount if (mode == \"valuation\" or include_hpp) else 0)\n    sp[\"gross_profit_before_overhead\"] = sp[\"gross_profit_before_overhead\"] + gross_profit_before_overhead\n    sp[\"gross_profit\"]                 = sp[\"gross_profit\"] + gross_profit\n    sp[\"base_profit\"]                  = sp[\"base_profit\"] + base_company_profit\n    sp[\"commission\"]                   = sp[\"commission\"] + sales_commission\n    sp[\"company_margin\"]               = sp[\"company_margin\"] + company_margin\n    sp[\"profit\"]                       = sp[\"profit\"] + company_profit\n\n    # ----------------------------------------\n    # Summary\n    # ----------------------------------------\n    s = result[\"summary\"]\n    s[\"total_sales\"]                        = s[\"total_sales\"] + sales_amount\n    s[\"total_hpp_base\"]                     = s[\"total_hpp_base\"] + (hpp_base_amount if (mode == \"valuation\" or include_hpp) else 0)\n    s[\"total_financial_cost\"]               = s[\"total_financial_cost\"] + (financial_cost_amount if (mode == \"valuation\" or include_hpp) else 0)\n    s[\"total_hpp_total\"]                    = s[\"total_hpp_total\"] + (hpp_total_amount if (mode == \"valuation\" or include_hpp) else 0)\n    s[\"total_gross_profit_before_overhead\"] = s[\"total_gross_profit_before_overhead\"] + gross_profit_before_overhead\n    s[\"total_gross_profit\"]                 = s[\"total_gross_profit\"] + gross_profit\n    s[\"total_base_profit\"]                  = s[\"total_base_profit\"] + base_company_profit\n    s[\"total_commission\"]                   = s[\"total_commission\"] + sales_commission\n    s[\"total_company_margin\"]               = s[\"total_company_margin\"] + company_margin\n    s[\"total_company_profit\"]               = s[\"total_company_profit\"] + company_profit\n\n    if is_return:\n        s[\"total_credit_notes\"]        = s[\"total_credit_notes\"] + 1\n        s[\"total_commission_negative\"] = s[\"total_commission_negative\"] + abs(sales_commission)\n    else:\n        s[\"total_invoices\"]            = s[\"total_invoices\"] + 1\n        s[\"total_commission_positive\"] = s[\"total_commission_positive\"] + sales_commission\n\n    i += 1\n\n# --- Set response ---\nfrappe.response[\"message\"] = result",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-02-25 21:34:01.281491",
  "module": "Batasku Custom",
  "name": "Auto Snapshot Hpp DN",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Delivery Note",
  "script": "# Server Script — Delivery Note, Event: Before Submit\n# Auto Snapshot HPP dan Financial Cost % saat DN di-submit\n\nfor i in range(len(doc.items)):\n    item = doc.items[i]\n    \n    # ========================================\n    # 1️⃣ SNAPSHOT HPP\n    # ========================================\n    \n    # Jika sudah ada snapshot → skip\n    if not item.custom_hpp_snapshot or item.custom_hpp_snapshot <= 0:\n        hpp = 0\n        \n        # Prioritas 1: incoming_rate → paling akurat\n        if item.incoming_rate and item.incoming_rate > 0:\n            hpp = item.incoming_rate\n        \n        # Prioritas 2: fallback Bin valuation_rate\n        if not hpp:\n            hpp = frappe.db.get_value(\n                \"Bin\",\n                {\"item_code\": item.item_code, \"warehouse\": item.warehouse},\n                \"valuation_rate\"\n            ) or 0\n        \n        # Prioritas 3: fallback Item Price (Standar Pembelian)\n        if not hpp:\n            hpp = frappe.db.get_value(\n                \"Item Price\",\n                {\"item_code\": item.item_code, \"price_list\": \"Standar Pembelian\"},\n                \"price_list_rate\"\n            ) or 0\n        \n        # Prioritas 4: fallback terakhir last_purchase_rate dari Item master\n        if not hpp:\n            hpp = frappe.db.get_value(\n                \"Item\",\n                item.item_code,\n                \"last_purchase_rate\"\n            ) or 0\n        \n        # HARD VALIDATION\n        if not hpp or hpp <= 0:\n            frappe.throw(\n                \"HPP tidak ditemukan untuk item {0}. \"\n                \"Periksa stok, valuation, price list, atau last purchase rate.\".format(item.item_code)\n            )\n        \n        # LOCK SNAPSHOT HPP\n        item.custom_hpp_snapshot = hpp\n    \n    # ========================================\n    # 2️⃣ SNAPSHOT FINANCIAL COST %\n    # ========================================\n    \n    # Jika sudah ada financial cost % → skip\n    if not item.custom_financial_cost_percent or item.custom_financial_cost_percent <= 0:\n        # Ambil dari Item master\n        fin_cost = frappe.db.get_value(\n            \"Item\",\n            item.item_code,\n            \"custom_financial_cost_percent\"\n        ) or 0\n        \n        # LOCK SNAPSHOT (0 juga valid = no overhead)\n        item.custom_financial_cost_percent = fin_cost",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-02-25 21:35:50.204793",
  "module": "Batasku Custom",
  "name": "Auto Snapshoot Hpp SI",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Sales Invoice",
  "script": "# Server Script — Sales Invoice, Event: Before Submit\n# Auto Snapshot HPP dan Financial Cost % dari DN atau fallback sources\n\nfor item in doc.items:\n    \n    # ========================================\n    # 1️⃣ SNAPSHOT HPP\n    # ========================================\n    \n    if not item.custom_hpp_snapshot or item.custom_hpp_snapshot <= 0:\n        hpp = 0\n        \n        # Prioritas 1: Delivery Note Item snapshot\n        if item.dn_detail:\n            dn_item = frappe.get_doc(\"Delivery Note Item\", item.dn_detail)\n            if dn_item.custom_hpp_snapshot and dn_item.custom_hpp_snapshot > 0:\n                hpp = dn_item.custom_hpp_snapshot\n            elif dn_item.incoming_rate and dn_item.incoming_rate > 0:\n                hpp = dn_item.incoming_rate\n        \n        # Prioritas 2: SINV incoming_rate fallback\n        if not hpp and item.incoming_rate and item.incoming_rate > 0:\n            hpp = item.incoming_rate\n        \n        # Prioritas 3: Bin.valuation_rate fallback\n        if not hpp:\n            hpp = frappe.db.get_value(\n                \"Bin\",\n                {\"item_code\": item.item_code, \"warehouse\": item.warehouse},\n                \"valuation_rate\"\n            ) or 0\n        \n        # Prioritas 4: Item Price List (Standar Pembelian) fallback\n        if not hpp:\n            hpp = frappe.db.get_value(\n                \"Item Price\",\n                {\"item_code\": item.item_code, \"price_list\": \"Standar Pembelian\"},\n                \"price_list_rate\"\n            ) or 0\n        \n        # Prioritas 5: Hard validation\n        if not hpp or hpp <= 0:\n            frappe.throw(\n                \"HPP tidak valid untuk item {0} di Sales Invoice {1}. \"\n                \"Periksa Delivery Note, stok, valuation, atau price list.\".format(\n                    item.item_code, doc.name\n                )\n            )\n        \n        # LOCK SNAPSHOT HPP\n        item.custom_hpp_snapshot = hpp\n    \n    # ========================================\n    # 2️⃣ SNAPSHOT FINANCIAL COST %\n    # ========================================\n    \n    if not item.custom_financial_cost_percent or item.custom_financial_cost_percent <= 0:\n        fin_cost = 0\n        \n        # Prioritas 1: Ambil dari Delivery Note Item snapshot\n        if item.dn_detail:\n            fin_cost = frappe.db.get_value(\n                \"Delivery Note Item\",\n                item.dn_detail,\n                \"custom_financial_cost_percent\"\n            ) or 0\n        \n        # Prioritas 2: Fallback ke Item master (kalau SINV dibuat manual tanpa DN)\n        if not fin_cost or fin_cost <= 0:\n            fin_cost = frappe.db.get_value(\n                \"Item\",\n                item.item_code,\n                \"custom_financial_cost_percent\"\n            ) or 0\n        \n        # LOCK SNAPSHOT (0 juga valid = no overhead)\n        item.custom_financial_cost_percent = fin_cost",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-02-18 16:38:01.982527",
  "module": "Batasku Custom",
  "name": "Nilai Komisi SO",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "",
  "script": "import frappe\n\nfrappe.log_error(\"=== SO COMMISSION SCRIPT START ===\", \"SO Commission Debug\")\n\n# 1️⃣ Ambil Sales Person dari Sales Team jika ada\nsp = None\nif doc.sales_team:\n    sp = doc.sales_team[0].sales_person\n    frappe.log_error(f\"Sales Person from Sales Team: {sp}\", \"SO Commission Debug\")\n\n# 2️⃣ Jika belum ada, ambil dari Customer\nif not sp and doc.customer:\n    sp = frappe.get_value(\"Customer\", doc.customer, \"sales_person\")\n    frappe.log_error(f\"Sales Person from Customer: {sp}\", \"SO Commission Debug\")\n\n    # Jika dapat, inject ke sales_team\n    if sp:\n        doc.append(\"sales_team\", {\n            \"sales_person\": sp,\n            \"allocated_percentage\": 100\n        })\n        frappe.log_error(\"Sales Team auto appended from Customer\", \"SO Commission Debug\")\n\n# 3️⃣ Ambil default commission rate dari Sales Person\nif sp:\n    rate = frappe.get_value(\"Sales Person\", sp, \"custom_default_commission_rate\") or 0\n    doc.custom_persentase_komisi_so = rate\n\n    frappe.log_error(\n        f\"Commission rate set: {rate}%\",\n        \"SO Commission Debug\"\n    )\nelse:\n    doc.custom_persentase_komisi_so = 0\n    frappe.log_error(\"No Sales Person found → Commission set 0\", \"SO Commission Debug\")\n\nfrappe.log_error(\"=== SO COMMISSION SCRIPT END ===\", \"SO Commission Debug\")\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-02-18 17:05:07.404656",
  "module": "Batasku Custom",
  "name": "Nilai Komisi DN",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Delivery Note",
  "script": "so_name = None\n\n# Ambil SO dari item pertama\nif doc.items:\n    so_name = doc.items[0].against_sales_order\n\nif so_name:\n    doc.custom_persentase_komisi_dn = frappe.db.get_value(\n        \"Sales Order\",\n        so_name,\n        \"custom_persentase_komisi_so\"\n    ) or 0\nelse:\n    doc.custom_persentase_komisi_dn = 0\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-02-28 00:53:59.711634",
  "module": "Batasku Custom",
  "name": "Nilai Komisi SI",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Sales Invoice",
  "script": "def execute(doc, method):\n    \"\"\"\n    Calculate commission for Sales Invoice\n    Handles cases where Delivery Note or Sales Order might not exist\n    \n    Note: frappe is already available in Server Script context, no import needed\n    \"\"\"\n    \n    # Check if items exist\n    if not doc.items or len(doc.items) == 0:\n        frappe.log_error(\"No items in Sales Invoice\", \"Nilai Komisi SI\")\n        return\n    \n    total_commission = 0\n    \n    for item in doc.items:\n        try:\n            # Initialize commission to 0\n            commission = 0\n            \n            # Try to get commission from Delivery Note first\n            if hasattr(item, 'delivery_note') and item.delivery_note:\n                try:\n                    dn_item = frappe.db.get_value(\n                        'Delivery Note Item',\n                        {'parent': item.delivery_note, 'item_code': item.item_code},\n                        'custom_komisi_sales'\n                    )\n                    if dn_item:\n                        commission = dn_item\n                except Exception as e:\n                    frappe.log_error(f\"Error fetching DN commission: {str(e)}\", \"Nilai Komisi SI\")\n            \n            # If no DN commission, try Sales Order\n            if commission == 0 and hasattr(item, 'sales_order') and item.sales_order:\n                try:\n                    so_item = frappe.db.get_value(\n                        'Sales Order Item',\n                        {'parent': item.sales_order, 'item_code': item.item_code},\n                        'custom_komisi_sales'\n                    )\n                    if so_item:\n                        commission = so_item\n                except Exception as e:\n                    frappe.log_error(f\"Error fetching SO commission: {str(e)}\", \"Nilai Komisi SI\")\n            \n            # Set commission for this item (default to 0 if not found)\n            item.custom_komisi_sales = commission\n            total_commission += commission\n            \n        except Exception as e:\n            # Log error but don't fail the save\n            frappe.log_error(f\"Error processing item {item.item_code}: {str(e)}\", \"Nilai Komisi SI\")\n            item.custom_komisi_sales = 0\n    \n    # Set total commission\n    doc.custom_total_komisi_sales = total_commission",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-02-27 21:04:43.950124",
  "module": "Batasku Custom",
  "name": "Auto Reverse Commission JE on Credit Note",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Sales Invoice",
  "script": "# ===============================\n# Server Script: Auto Reverse Commission JE on Credit Note\n# Trigger: Sales Invoice on_submit\n# ===============================\n\n# Deteksi apakah ini Credit Note (Return Invoice)\nif doc.is_return and doc.return_against:\n    \n    # Cek apakah Credit Note ini punya nilai komisi\n    if not doc.custom_total_komisi_sales:\n        frappe.msgprint(f\"Credit Note {doc.name} tidak memiliki komisi, JE pembalik tidak dibuat.\")\n    else:\n        reversed_commission = abs(doc.custom_total_komisi_sales)\n        \n        if reversed_commission <= 0:\n            frappe.msgprint(f\"Credit Note {doc.name} tidak memiliki komisi, JE pembalik tidak dibuat.\")\n        else:\n            company = doc.company\n            \n            # ===========================\n            # CARI AKUN EXPENSE & PAYABLE\n            # ===========================\n            \n            expense_keywords = [\"Beban Komisi Penjualan\", \"Komisi Penjualan\"]\n            payable_keywords = [\"Hutang Komisi Sales\", \"Komisi Sales\"]\n            \n            expense_account = None\n            payable_account = None\n            \n            for kw in expense_keywords:\n                expense_account = frappe.db.get_value(\n                    \"Account\",\n                    {\"company\": company, \"account_type\": \"Expense Account\", \"account_name\": [\"like\", f\"%{kw}%\"]},\n                    \"name\"\n                )\n                if expense_account:\n                    break\n            \n            for kw in payable_keywords:\n                payable_account = frappe.db.get_value(\n                    \"Account\",\n                    {\"company\": company, \"account_type\": \"Payable\", \"account_name\": [\"like\", f\"%{kw}%\"]},\n                    \"name\"\n                )\n                if payable_account:\n                    break\n            \n            if not expense_account:\n                frappe.throw(f\"Tidak ditemukan akun Expense untuk komisi di company '{company}'\")\n            if not payable_account:\n                frappe.throw(f\"Tidak ditemukan akun Payable untuk komisi di company '{company}'\")\n            \n            # ===========================\n            # AMBIL EMPLOYEE DARI SALES ORDER\n            # ===========================\n            \n            if not doc.items or not doc.items[0].sales_order:\n                frappe.throw(\n                    f\"Credit Note {doc.name} tidak memiliki Sales Order di item pertama. \"\n                    f\"JE pembalik tidak bisa dibuat.\"\n                )\n            \n            first_so = doc.items[0].sales_order\n            \n            # Ambil Sales Team dari SO\n            sales_person_list = frappe.get_all(\n                \"Sales Team\",\n                filters={\"parent\": first_so},\n                fields=[\"sales_person\"]\n            )\n            \n            if not sales_person_list:\n                frappe.throw(\n                    f\"Sales Order {first_so} tidak memiliki Sales Person. \"\n                    f\"JE pembalik tidak bisa dibuat.\"\n                )\n            \n            # Loop cek Employee untuk tiap Sales Person\n            employee_party = None\n            employee_debug_list = []\n            \n            for sp in sales_person_list:\n                emp = frappe.db.get_value(\"Sales Person\", sp.sales_person, \"employee\")\n                employee_debug_list.append({\n                    \"so\": first_so,\n                    \"sales_person\": sp.sales_person,\n                    \"employee\": emp\n                })\n                if emp and not employee_party:\n                    employee_party = emp\n            \n            # Log debug\n            error_message = f\"Credit Note {doc.name}: Sales Team & Employee mapping: {employee_debug_list}\"\n            frappe.log_error(\n                message=error_message,\n                title=f\"Commission Reversal Debug {doc.name}\"\n            )\n            \n            # Validasi Employee\n            if not employee_party:\n                frappe.throw(\n                    f\"Credit Note {doc.name}: Tidak ditemukan Employee untuk komisi di Sales Order {first_so}. \"\n                    f\"Pastikan semua Sales Person terkait Employee sebelum submit.\"\n                )\n            \n            # ===========================\n            # BUAT REVERSAL JOURNAL ENTRY\n            # ===========================\n            \n            reverse_je = frappe.new_doc(\"Journal Entry\")\n            reverse_je.voucher_type = \"Journal Entry\"\n            reverse_je.posting_date = doc.posting_date\n            reverse_je.company = company\n            reverse_je.user_remark = (\n                f\"Reversal Commission for Credit Note {doc.name} \"\n                f\"(against Invoice {doc.return_against})\"\n            )\n            \n            # DEBIT Hutang Komisi Sales (mengurangi liability)\n            reverse_je.append(\"accounts\", {\n                \"account\": payable_account,\n                \"debit_in_account_currency\": reversed_commission,\n                \"party_type\": \"Employee\",\n                \"party\": employee_party\n            })\n            \n            # CREDIT Beban Komisi Penjualan (mengurangi expense)\n            reverse_je.append(\"accounts\", {\n                \"account\": expense_account,\n                \"credit_in_account_currency\": reversed_commission\n            })\n            \n            reverse_je.insert(ignore_permissions=True)\n            reverse_je.submit()\n            \n            # Link JE pembalik ke Credit Note\n            doc.db_set(\"custom_commission_journal_entry\", reverse_je.name)\n            \n            frappe.msgprint(\n                f\"✓ Reversal Journal Entry {reverse_je.name} berhasil dibuat untuk Credit Note {doc.name}<br>\"\n                f\"Komisi dibalik: {reversed_commission}\",\n                indicator=\"green\"\n            )",
  "script_type": "DocType Event"
 }
]
[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Invoice",
  "enabled": 1,
  "modified": "2026-02-28 05:10:48.759928",
  "module": "Batasku Custom",
  "name": "Skrip Komisi Penjualan",
  "script": "// ===============================\n// Client Script: Commission Calculator for Sales Invoice & Credit Note (FIXED)\n// ===============================\n\nfrappe.ui.form.on('Sales Invoice', {\n    sales_team_add: function(frm) {\n        recalculate_all_items(frm);\n    },\n    refresh: function(frm) {\n        // PERBAIKAN: Hanya recalculate jika form baru (belum ada name) atau is_new\n        // Jangan recalculate pada form yang sudah saved untuk menghindari \"Not Saved\" status\n        if (frm.is_new() || !frm.doc.name) {\n            recalculate_all_items(frm);\n        }\n    },\n    // Trigger khusus untuk Credit Note\n    is_return: function(frm) {\n        if (frm.doc.is_return) {\n            recalculate_all_items(frm);\n        }\n    }\n});\n\nfrappe.ui.form.on('Sales Team', {\n    sales_person: function(frm) {\n        recalculate_all_items(frm);\n    },\n    allocated_percentage: function(frm) {\n        recalculate_all_items(frm);\n    }\n});\n\nfrappe.ui.form.on('Sales Invoice Item', {\n    qty: function(frm, cdt, cdn) { \n        calculate_commission_row(frm, cdt, cdn); \n    },\n    margin_rate_or_amount: function(frm, cdt, cdn) { \n        calculate_commission_row(frm, cdt, cdn); \n    },\n    custom_komisi_sales: function(frm) { \n        calculate_total_commission_header(frm); \n    },\n    items_remove: function(frm) { \n        calculate_total_commission_header(frm); \n    },\n    items_add: function(frm, cdt, cdn) {\n        calculate_commission_row(frm, cdt, cdn);\n    }\n});\n\nasync function recalculate_all_items(frm) {\n    if (frm.doc.items && frm.doc.items.length > 0) {\n        for (let item of frm.doc.items) {\n            await calculate_commission_row(frm, item.doctype, item.name);\n        }\n        frm.refresh_field('items');\n    }\n}\n\nfunction calculate_commission_row(frm, cdt, cdn) {\n    let item = locals[cdt][cdn];\n    \n    // Ambil persentase komisi dari SO (snapshot)\n    let rate_percent = frm.doc.custom_persentase_komisi_so || 0;\n    let rate = parseFloat(rate_percent) / 100;\n    \n    // Hitung komisi item: Margin √ó Qty √ó Rate%\n    let margin = flt(item.margin_rate_or_amount);\n    let qty = flt(item.qty);\n    \n    // PENTING: Untuk Credit Note, qty sudah negatif dari ERPNext\n    // Jadi kita gunakan abs() agar komisi tetap positif\n    let row_commission = Math.abs(margin * qty * rate);\n    \n    // PERBAIKAN: Hanya set value jika berbeda untuk menghindari unnecessary dirty flag\n    if (flt(item.custom_komisi_sales) !== row_commission) {\n        frappe.model.set_value(cdt, cdn, 'custom_komisi_sales', row_commission);\n    }\n}\n\nfunction calculate_total_commission_header(frm) {\n    let total = 0;\n    \n    // Jumlahkan semua komisi item\n    (frm.doc.items || []).forEach(i => {\n        total += flt(i.custom_komisi_sales);\n    });\n    \n    // PERBAIKAN: Hanya set value jika berbeda\n    if (flt(frm.doc.custom_total_komisi_sales) !== total) {\n        frm.set_value('custom_total_komisi_sales', total);\n    }\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Commission Payment",
  "enabled": 1,
  "modified": "2026-02-27 21:23:28.440847",
  "module": "Batasku Custom",
  "name": "Auto Fill Commission From Invoice",
  "script": "// ===============================\n// Client Script: Sales Commission Payment (Support Credit Note)\n// DocType: Sales Commission Payment\n// ===============================\n\n// FILTER: Invoice Paid & Credit Note Allocated\nfrappe.ui.form.on('Sales Commission Payment', {\n    refresh: function(frm) {\n        frm.set_query(\"sales_invoice\", \"items\", function() {\n            return {\n                filters: [\n                    ['docstatus', '=', 1],\n                    ['outstanding_amount', '=', 0],\n                    ['custom_total_komisi_sales', '!=', 0]\n                ]\n            };\n        });\n        \n        // Reset flag button saat refresh\n        frm.custom_button_added = false;\n    }\n});\n\n// AUTO FILL Customer & Commission (Support CN)\nfrappe.ui.form.on('Sales Commission Payment Item', {\n    sales_invoice: function(frm, cdt, cdn) {\n        let row = locals[cdt][cdn];\n        \n        if (row.sales_invoice) {\n            frappe.db.get_value(\n                'Sales Invoice',\n                row.sales_invoice,\n                [\n                    'customer',\n                    'custom_total_komisi_sales',\n                    'outstanding_amount',\n                    'is_return',\n                    'return_against'\n                ]\n            ).then(r => {\n                if (r.message) {\n                    let data = r.message;\n                    \n                    // Safety check: pastikan lunas/allocated\n                    if (data.outstanding_amount != 0) {\n                        frappe.msgprint({\n                            title: 'Invoice Belum Lunas',\n                            message: data.is_return ? \n                                'Credit Note belum fully allocated.' : \n                                'Invoice belum dibayar customer.',\n                            indicator: 'red'\n                        });\n                        frappe.model.set_value(cdt, cdn, 'sales_invoice', '');\n                        return;\n                    }\n                    \n                    // Set Customer\n                    frappe.model.set_value(cdt, cdn, 'customer', data.customer);\n                    \n                    // Set Commission Amount\n                    let commission = data.custom_total_komisi_sales || 0;\n                    \n                    // PENTING: Untuk Credit Note, komisi jadi NEGATIF\n                    if (data.is_return) {\n                        commission = -Math.abs(commission);\n                        \n                        // Info untuk user\n                        frappe.show_alert({\n                            message: `Credit Note: Komisi dikurangi ${Math.abs(commission).toLocaleString('id-ID')}`,\n                            indicator: 'orange'\n                        });\n                    }\n                    \n                    frappe.model.set_value(cdt, cdn, 'commission_amount', commission);\n                    \n                    // Optional: Set return_against untuk tracking\n                    if (data.is_return && data.return_against) {\n                        frappe.model.set_value(cdt, cdn, 'return_against', data.return_against);\n                    }\n                }\n            });\n        }\n    },\n    \n    // Recalculate total saat commission berubah\n    commission_amount: function(frm) {\n        calculate_total_commission(frm);\n    },\n    \n    items_remove: function(frm) {\n        calculate_total_commission(frm);\n    }\n});\n\n// CALCULATE TOTAL (Support Negative Values)\nfunction calculate_total_commission(frm) {\n    let total = 0;\n    let positive = 0;\n    let negative = 0;\n    \n    (frm.doc.items || []).forEach(i => {\n        let amount = flt(i.commission_amount);\n        total += amount;\n        \n        if (amount >= 0) {\n            positive += amount;\n        } else {\n            negative += Math.abs(amount);\n        }\n    });\n    \n    frm.set_value('total_commission', total);\n    \n    // Tampilkan alert jika ada pengurangan dari Credit Note\n    if (negative > 0 && frm.doc.docstatus === 0) {\n        frappe.show_alert({\n            message: `üí∞ Komisi: ${positive.toLocaleString('id-ID')} | ‚ùå Pengurangan: -${negative.toLocaleString('id-ID')} | ‚úÖ Net: ${total.toLocaleString('id-ID')}`,\n            indicator: 'blue'\n        }, 15);\n    }\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Mode of Payment",
  "enabled": 0,
  "modified": "2026-02-15 17:17:41.647612",
  "module": "Batasku Custom",
  "name": "Mode Warkat",
  "script": "frappe.ui.form.on('Mode of Payment', {\n    refresh: function(frm) {\n        // override query Default Account\n        frm.set_query('default_account', function() {\n            return {\n                filters: {\n                    'company': frm.doc.company, // harus sama company\n                    'is_group': 0,\n                    'account_type': ['in', ['Bank', 'Cash', 'Current Asset']], // tambah Current Asset untuk Warkat Masuk\n                    'root_type': ['in', ['Asset','Liability']]\n                }\n            };\n        });\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Delivery Note",
  "enabled": 0,
  "modified": "2026-02-18 00:23:49.248211",
  "module": "Batasku Custom",
  "name": "Auto Snapshoot Hpp DN",
  "script": "// Client Script ‚Äî DocType: Delivery Note\n// Capture incoming_rate ke custom_hpp_snapshot saat stock keluar\n// Ini titik paling akurat karena moving average dihitung saat DN dibuat\n\nfrappe.ui.form.on(\"Delivery Note Item\", {\n\n    item_code: function(frm, cdt, cdn) {\n        capture_dn_hpp(frm, cdt, cdn);\n    },\n\n    qty: function(frm, cdt, cdn) {\n        capture_dn_hpp(frm, cdt, cdn);\n    },\n\n    incoming_rate: function(frm, cdt, cdn) {\n        capture_dn_hpp(frm, cdt, cdn);\n    },\n\n});\n\nfunction capture_dn_hpp(frm, cdt, cdn) {\n    var row = locals[cdt][cdn];\n    if (frm.doc.docstatus === 0 && row.incoming_rate) {\n        frappe.model.set_value(cdt, cdn, \"custom_hpp_snapshot\", row.incoming_rate);\n    }\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Invoice",
  "enabled": 0,
  "modified": "2026-02-18 00:24:32.524216",
  "module": "Batasku Custom",
  "name": "Auto Snapshoot Hpp SI",
  "script": "// Client Script ‚Äî DocType: Sales Invoice\n// Ambil custom_hpp_snapshot dari Delivery Note Item saat SINV dibuat dari DN\n// Fallback ke incoming_rate kalau DN tidak ada\n\nfrappe.ui.form.on(\"Sales Invoice Item\", {\n\n    // Trigger saat item di-load dari DN (via fetch atau manual)\n    item_code: function(frm, cdt, cdn) {\n        capture_sinv_hpp(frm, cdt, cdn);\n    },\n\n    qty: function(frm, cdt, cdn) {\n        capture_sinv_hpp(frm, cdt, cdn);\n    },\n\n    incoming_rate: function(frm, cdt, cdn) {\n        capture_sinv_hpp(frm, cdt, cdn);\n    },\n\n    // Trigger khusus saat row di-load dari Delivery Note\n    dn_detail: function(frm, cdt, cdn) {\n        var row = locals[cdt][cdn];\n\n        // Kalau SINV dibuat dari DN, ambil custom_hpp_snapshot dari DN Item\n        if (frm.doc.docstatus === 0 && row.dn_detail) {\n            frappe.db.get_value(\n                \"Delivery Note Item\",\n                row.dn_detail,\n                \"custom_hpp_snapshot\",\n                function(data) {\n                    if (data && data.custom_hpp_snapshot) {\n                        frappe.model.set_value(\n                            cdt, cdn,\n                            \"custom_hpp_snapshot\",\n                            data.custom_hpp_snapshot\n                        );\n                    } else {\n                        // Fallback ke incoming_rate kalau DN snapshot tidak ada\n                        capture_sinv_hpp(frm, cdt, cdn);\n                    }\n                }\n            );\n        } else {\n            capture_sinv_hpp(frm, cdt, cdn);\n        }\n    },\n\n});\n\nfunction capture_sinv_hpp(frm, cdt, cdn) {\n    var row = locals[cdt][cdn];\n    // Hanya isi kalau belum ada nilai dari DN dan invoice masih draft\n    if (frm.doc.docstatus === 0 && row.incoming_rate && !row.custom_hpp_snapshot) {\n        frappe.model.set_value(cdt, cdn, \"custom_hpp_snapshot\", row.incoming_rate);\n    }\n}",
  "view": "Form"
 }
]